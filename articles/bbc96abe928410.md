---
title: "[Python]pipenv + Github Actionsã§DevOps"
emoji: "ğŸ˜¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python", "github", "pipenv"]
published: true
---

Pythonã§ãƒã‚¿ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã‚’ä½œã£ãŸã®ã§ã™ãŒã€`pipenv` + `Github Actions` ã‚’äº¤ãˆã¦ã€ï¼ˆãƒã‚¿ãƒ„ãƒ¼ãƒ«ã«ã—ã¦ã¯ï¼‰å …ç‰¢ã«DevOpsã‚’ã—ãŸã®ã§ã€ãƒãƒã£ãŸãƒã‚¤ãƒ³ãƒˆç­‰ã‚’è¦šæ›¸ã—ã¾ã™ã€‚

https://github.com/prs-watch/hof

:::message
PyPIã«ã‚‚ã‚¢ãƒƒãƒ—ã—ã¦ã„ã‚‹ã®ã§ã€`pip install hof` å‡ºæ¥ã¾ã™ï¼
:::

# `pipenv`

https://pipenv-ja.readthedocs.io/ja/translate-ja/index.html

Pythonã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã€‚Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ã® `npm` ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã§ã™ãŒã€`virtualenv` ã®æ§˜ã«Pythonã®ä»®æƒ³ç’°å¢ƒã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ãƒˆå‡ºæ¥ã‚‹ã®ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–‰ã˜ãŸã‚ªãƒ³ãƒªãƒ¼ãƒ¯ãƒ³ãªç’°å¢ƒã‚’ã‚ã£ã•ã‚Šã¨ä½œã‚Šä¸Šã’ã‚‹ã“ã¨ãŒå¯ã€‚

# `Github Actions`

https://github.co.jp/features/actions

GithubãŒã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚µãƒ¼ãƒ“ã‚¹ã€‚`YAML` ã‚’ä¸Šæ‰‹ãæ›¸ãã¨ã€ãƒ“ãƒ«ãƒ‰ç’°å¢ƒã‚’ç«‹ã¦ã¦ã€ãƒ†ã‚¹ãƒˆã‚„ãƒªãƒªãƒ¼ã‚¹ç­‰ã‚’è¡Œãˆã‚‹ã€‚ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«ã•ã‚Œã¦ã„ã‚‹æ±ç”¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®æ§˜ãªç‰©ã‚’ç”¨ã„ã‚‹ã¨ã€ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã‚„ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒªãƒªãƒ¼ã‚¹ç­‰ã‚‚æ¥½ã«å®Ÿç¾å¯ã¨ã€ã¨ã¦ã‚‚ä¾¿åˆ©ã€‚

# `pipenv` è¦šæ›¸

## ä»®æƒ³ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

```bash
$ pipenv --python 3
```

`pipenv` ã§ä¾å­˜ç®¡ç†ã‚’è¡Œã†ãƒ•ã‚¡ã‚¤ãƒ« `Pipfile` ãŒä½œã‚‰ã‚Œã¾ã™ã€‚

## ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
$ pipenv install pybaseball
```

ãƒ†ã‚¹ãƒˆã‚„ãƒ“ãƒ«ãƒ‰ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç­‰ã«å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œã‚‹å ´åˆã¯ã€`--dev` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å…¥ã‚Œã¦ã€`dev-packages` ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```bash
$ pipenv install --dev twine wheel
```

ã“ã‚Œã‚‰ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯Pythonã®ã€Œä»®æƒ³ç’°å¢ƒã€ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒã‚·ãƒ³ã¯ã‚¯ãƒªãƒ¼ãƒ³ãªã¾ã¾ã§ã™ã€‚ä»®æƒ³ç’°å¢ƒã®ä¸­ã® `pip` ã«ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå…¥ã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–‰ã˜ãŸã‚ªãƒ³ãƒªãƒ¼ãƒ¯ãƒ³ãªç’°å¢ƒã« `Python` ã¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒè©°ã¾ã£ã¦ã„ã‚‹ã€ãã‚“ãªçŠ¶æ³ã§ã™ã€‚

### `Pipfile.lock`

`pipenv install` ã§ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œã‚‹ã¨ã€ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¿æŒã™ã‚‹ `Pipfile.lock` ãŒä½œã‚‰ã‚Œã¾ã™ã€‚`npm` ã§è¨€ã† `package-lock.json` ã¨åŒç­‰ã€‚

ãŸã ã—ã€ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«äººåŠ›ã§æ‰‹ã‚’å…¥ã‚Œã‚‹ã“ã¨ã¯ç„¡ã„ã®ã§ã€ã€ŒãŠã€ã‚ã‚‹ãªãƒ¼ã€ãã‚‰ã„ãªãƒ†ãƒ³ã‚·ãƒ§ãƒ³ã§è‰¯ã„ã§ã™ã€‚

## ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ

### `pipenv run`

`npm` ã¨åŒã˜ãã€`pipenv` ã‚‚ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®šç¾©ã®ä¸Šã€å®Ÿè¡ŒãŒå‡ºæ¥ã¾ã™ã€‚
`&&` ã§ã¤ãªã„ã§è¤‡æ•°ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯ã€`bash -c` ã§ãƒ‘ã‚¹ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚‹æ§˜ã§ã™ã€‚

```:Pipfile
...
[scripts]
test = "bash -c 'python -m pip install -e . && pytest tests'"
build = "bash -c 'python setup.py sdist && python setup.py bdist_wheel'"
```

ã¨æ›¸ãã€ä¾‹ãˆã°ã€Œã‚ãƒ¼ã€ãƒ†ã‚¹ãƒˆã§ã‚‚ã™ã‚‹ã‹ãƒ¼ã€ã¨ã®æ°—åˆ†ã«ãªã‚Œã°

```bash
$ pipenv run test
```

ã§å®Ÿè¡Œã€‚

### ä»®æƒ³ç’°å¢ƒã®ä¸­ã§ã‚³ãƒãƒ³ãƒ‰å®Ÿè¡Œ

```bash
$ pipenv shell
```

ã§ã€ä»®æƒ³ç’°å¢ƒã®ä¸­ã«å…¥ã‚Šã¾ã™ã€‚`docker exec` ã®æ§˜ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€‚
ã“ã®ä¸­ã§ã¯ã€ä»®æƒ³ç’°å¢ƒã®ä¸­ã® `Python` `pip` ã«ã‚¢ã‚¯ã‚»ã‚¹å‡ºæ¥ã‚‹ãŸã‚ã€è‡ªä½œãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ãƒ†ã‚¹ãƒˆã‚’ãƒ©ãƒ•ã«æ›¸ãã“ã¨ãŒå¯ã€‚

# `Github Actions` è¦šæ›¸

ä¸»ã« `pipenv` ã‚’åˆ©ç”¨ã—ãªãŒã‚‰ã®ãƒ•ãƒ­ãƒ¼ä½œã‚Šã€ã¨ã®è¦³ç‚¹ã§ã€‚ã¨ã¯è¨€ãˆã€åŸºæœ¬ã¯ `YAML` ã«ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¹ãƒ†ãƒƒãƒ—æ¯ã«æ›¸ãå½¢ãªã®ã§ã€ã‚ã‚“ã¾ã‚Šãƒãƒã‚‹ãƒã‚¤ãƒ³ãƒˆã¯ç„¡ã‹ã£ãŸã§ã™ã€‚

## `pipenv` ç’°å¢ƒã®å†ç¾

`Pipfile` ã¨ `Pipfile.lock` ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ã€`pipenv sync --dev` ã§é–‹ç™ºç”¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚‚å…¥ã‚ŒãŸã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¯ã€‚

### `Warning: Python 3.10 was not found on your system...`

ãŒã€ã€`Pipfile` ã®ä¸­ã«Pythonãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒ `3.10` ã¨ã•ã‚Œã¦ã„ã¾ã—ãŸãŒã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç’°å¢ƒä¸Šã«ç„¡ã„ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã£ãŸæ§˜ã§ã™ã€‚
`Github Actions` å´ã®ç’°å¢ƒãŒã©ã†ãªã£ã¦ã„ã‚‹ã‹ã¯åˆ†ã‹ã‚‰ã‚“ã®ã§ã€`pipenv` ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚ªã‚¹ã‚¹ãƒ¡ã•ã‚Œã‚‹å½¢ã§ç®¡ç†ã‚’ç›´ã—ã¾ã™ã€‚

https://pipenv-ja.readthedocs.io/ja/translate-ja/basics.html

> è¤‡æ•°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®Pythonã‚’å¯¾è±¡ã¨ã™ã‚‹å ´åˆã¯ã€ Pipfile.lock ã¯ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«å«ã‚ãªã„ã§ãã ã•ã„ã€‚

ã“ã®ä¸Šã§ã€

```bash
# Pipfile.lockã‚’ç”Ÿæˆ
$ pipenv lock

# syncã™ã‚‹
$ pipenv sync --dev
```

## ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å…¨ä½“

### ãƒ†ã‚¹ãƒˆ

```yml:test.yml
name: test

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: install pipenv
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipenv
      
      - name: lock package version
        run: pipenv lock
      
      - name: install packages
        run: pipenv sync --dev
      
      - name: run test
        run: pipenv run test
```

### ãƒªãƒªãƒ¼ã‚¹

```yml:release.yml
name: release

on:
  workflow_dispatch:

jobs:
  release:
    runs-on: ubuntu-20.04
    steps:
      - name: checkout
        uses: actions/checkout@v2

      - name: install pipenv
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipenv
      
      - name: lock package version
        run: pipenv lock
      
      - name: install packages
        run: pipenv sync --dev

      - name: build
        run: pipenv run build

      - name: release
        uses: pypa/gh-action-pypi-publish@master
        with: 
          user: __token__
          password: ${{ secrets.PYPI_API_TOKEN }}
```

# ã¾ã¨ã‚

ã‚¯ãƒªãƒ¼ãƒ³ã«ç’°å¢ƒã‚’ä½œã‚Šã¤ã¤ã€ãƒ†ã‚¹ãƒˆã‚„ãƒªãƒªãƒ¼ã‚¹ã‚‚æ¥½ã«ãã‚‹ãã‚‹å›ã›ã¦ã€ã¨ã¦ã‚‚è‰¯ã‹ã£ãŸã§ã™ã€‚ãƒã‚¿ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ã«ã¯ãƒªãƒƒãƒã™ãã‚‹ãã‚‰ã„ã€ã€

Pythonã®å ´åˆã¯ã»ã¨ã‚“ã©ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æµç”¨å‡ºæ¥ã‚‹æ°—ãŒã™ã‚‹ã®ã§ã€ã“ã‚Œã‹ã‚‰ã¯DevOpsãŒæ¥½ã«å®Ÿç¾å‡ºæ¥ãã†ã§ã™ï¼
`Github Actions` ã®ãƒ‡ãƒãƒƒã‚°ãŒè¾›ã‹ã£ãŸãªãƒ¼ã€ã¨ã®æ°—ã¯ã™ã‚‹ã®ã§ã€ä»Šåº¦ã¯ `act` ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ã¿ã‚ˆã†ã€ã€

https://dev.classmethod.jp/articles/act-for-github-actions-local-execution-tool/